# IMPORTANT: Do not move this file in your repo! Make sure it's located at .github/workflows/claude-dispatch.yml
name: Claude Code Dispatch

# IMPORTANT: Do not modify this `on` section!
on:
  repository_dispatch:
    types: [claude-dispatch]

jobs:
  claude-dispatch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write 
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # - name: Preliminary Setup
        # run: |
          # echo "Setting up environment..."
          # Add any preliminary setup commands here to setup Claude's dev environment
          # e.g., npm install, etc.
      - name: Generate GitHub App auth token (valid for 1hr)
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLAUDE_APP_CLIENT_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Configure Git Client
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          BOT_USER_ID="$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)"
          BOT_USER_NAME='${{ steps.app-token.outputs.app-slug }}[bot]'

          # todo probably unnecessary to configure the username and email but the token is necessary for it to be able to pull and push
          # to other repos without manual setup for the auth
          git config --global user.name "$BOT_USER_NAME"
          git config --global user.email "$BOT_USER_ID+$BOT_USER_NAME@users.noreply.github.com"

          # uses GH_TOKEN from env to auth pushes/pulls to github
          gh auth setup-git

          echo "::group::gh auth status"
          gh auth status
          echo "::endgroup::"

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@eap
        with:
          mode: 'remote-agent'
          
          # Optional: Specify an API key, otherwise we'll use your Claude account automatically
          # anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"
          
          additional_permissions: |
            actions: read

          # Optional: Allow Claude to run specific commands
          allowed_tools: |
            Task
            Bash
            Glob
            Grep
            LS
            exit_plan_mode
            Read
            Edit
            MultiEdit
            Write
            NotebookRead
            NotebookEdit
            TodoWrite
            WebSearch
            WebFetch
            ListMcpResourcesTool
            ReadMcpResourceTool
            mcp__github_comment__update_claude_comment
            mcp__github_ci__get_ci_status
            mcp__github_ci__get_workflow_run_details
            mcp__github_ci__download_job_log

          # Optional: Custom environment variables for Claude
          claude_env: |
            GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
            
